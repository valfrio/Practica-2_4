
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mydomain.org/mysite/">
      
      
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.43">
    
    
      
        <title>My Docs</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.0253249f.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#practica-24-balanceo-de-carga-con-proxy-inverso-en-nginx" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Práctica 2.4 – Balanceo de carga con proxy inverso en Nginx
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Práctica 2.4 – Balanceo de carga con proxy inverso en Nginx
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Práctica 2.4 – Balanceo de carga con proxy inverso en Nginx
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ips" class="md-nav__link">
    <span class="md-ellipsis">
      IPs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-los-webservers" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración de los webservers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-del-balanceador-de-carga" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración del balanceador de carga
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cuestiones-finales" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestiones finales
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cuestiones finales">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuestion-1" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestión 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuestion-2" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestión 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuestion-3" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestión 3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ips" class="md-nav__link">
    <span class="md-ellipsis">
      IPs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-de-los-webservers" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración de los webservers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuracion-del-balanceador-de-carga" class="md-nav__link">
    <span class="md-ellipsis">
      Configuración del balanceador de carga
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cuestiones-finales" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestiones finales
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cuestiones finales">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cuestion-1" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestión 1
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuestion-2" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestión 2
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#cuestion-3" class="md-nav__link">
    <span class="md-ellipsis">
      Cuestión 3
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="practica-24-balanceo-de-carga-con-proxy-inverso-en-nginx">Práctica 2.4 – Balanceo de carga con proxy inverso en Nginx</h1>
<h2 id="ips">IPs</h2>
<p>Para esta práctica las IPs de mis servidores han sido:</p>
<ul>
<li>ip webserver1 192.168.43.47</li>
<li>ip webserver2 192.168.43.46</li>
<li>ip proxy 192.168.43.101</li>
</ul>
<h2 id="configuracion-de-los-webservers">Configuración de los webservers</h2>
<p>Para ello primero debemos que cambiar el nombre de webserver por webserver1 en todos los sitios que aparezca. Para ello primer eliminamos el enlace simbólico en el servidor 1:</p>
<p><img alt="imagen 1" src="assets/images/1.png" /></p>
<p>Cambiamos el nombre de la carpeta del servidor y creamos la ruta /var/www/webserver1/html . Ahora esta será la ruta de nuestra pagina web</p>
<p><img alt="imagen 2" src="assets/images/3.png" /></p>
<p>Ahora debemos quitar la página web que descargamos en la práctica anterior
y remplazarlo por el siguiente html:</p>
<p><img alt="imagen 3" src="assets/images/24.png" /></p>
<p>Que para el server 1 quedaría:</p>
<p><img alt="imagen 4" src="assets/images/4.png" /></p>
<p>Cambiamos el nombre a los archivos de configuración:</p>
<p><img alt="imagen 5" src="assets/images/5.png" /></p>
<p>Ahora el paso más importante, el archivo de configuración. Solo tenemos que cambiar el nombre del servidor y de la cabecera a webserver1 y Serv_Web1_salva para la cabecera:</p>
<p><img alt="imagen 6" src="assets/images/6.png" /></p>
<p>Por último volvemos a crear el enlace simbólico:</p>
<p><img alt="imagen 7" src="assets/images/7.png" /></p>
<p>Reiniciamos el servicio y ahora debemos de clonar el webserver que acabamos de hacer pero eligiendo la opción de virtual box que nos da una nueva dirección MAC. Esto es para que el router le asigne una nueva IP. </p>
<p>Repetimos todo el proceso de la misma forma:</p>
<p><img alt="imagen 8" src="assets/images/8.png" /></p>
<p>Creamos el html con el nombre bien puesto:</p>
<p><img alt="imagen 9" src="assets/images/9.png" /></p>
<p>Cambiamos nombre</p>
<p><img alt="imagen 10" src="assets/images/10.png" /></p>
<p><img alt="imagen 11" src="assets/images/11.png" /></p>
<p>Una vez hecho volvemos a crear el enlace simbólico</p>
<p><img alt="imagen 12" src="assets/images/12.png" /></p>
<p>Ahora debemos de cambiar el archivo de configuración de la misma forma:</p>
<p><img alt="imagen 13" src="assets/images/14.png" /></p>
<h2 id="configuracion-del-balanceador-de-carga">Configuración del balanceador de carga</h2>
<p>Ahora debemos de cambiar el nombre de lso archivos de configuración por balanceo</p>
<p><img alt="imagen 14" src="assets/images/15.png" /></p>
<p>Ahora el paso clave. Debemos de cambiar el archivo de configuración para que el proxy-balanceador de carga redirija el tráfico a los dos servidores. Para ello debemos cambiar el archivo para que tenga este formato:</p>
<pre><code> upstream backend_hosts {
                random;
                server ________:____;
                server ________:____;
    }
            server {
                listen 80;
                server_name ________;      
                location / {
                    proxy_pass http://backend_hosts;
                }
            }
</code></pre>
<p>El bloque de server se encarga de redirigir el tráfico a los backend_hosts. Estos son el grupo de servidores definidos arriba en el bloque de upstream. Este bloque se encarga de la redirección y de que patrón seguir, en nuestro caso random para mayor simplicidad. Ahí añadiremos los servidores, donde la primera raya es donde tiene que estar la ip del servidor y en la siguiente raya después de los dos puntos el puerto que escucha el servidor. </p>
<p>El archivo de configuración en mi caso quedó:</p>
<p><img alt="imagen 15" src="assets/images/16.png" /></p>
<p>Ahora entramos para comprobar que funciona</p>
<p><img alt="imagen 16" src="assets/images/17.png" /></p>
<p>Podemos ver que nos ha servido el primer servidor. Si recargamos las suficientes veces veremos que nos servirá el segundo servidor</p>
<p><img alt="imagen 17" src="assets/images/18.png" /></p>
<p>Podemos ver los logs de acceso para mayor seguridad:</p>
<p><img alt="imagen 18" src="assets/images/19.png" /></p>
<p><img alt="imagen 19" src="assets/images/20.png" /></p>
<p>Ahora veremos que el balanceador comprueba que los servicios estén activos a la hora de redirigir. Pararemos el servicio en ambas máquinas y veremos que efectivamente redirige a la otra todo el rato. Comenzamos con el primer servidor:</p>
<p><img alt="imagen 20" src="assets/images/21.png" /></p>
<p>Efectivamente me redirigió solo al servidor 2.</p>
<p><img alt="imagen 21" src="assets/images/18.png" /></p>
<p>Iniciamos de nuevo el servicio</p>
<p><img alt="imagen 22" src="assets/images/22.png" /></p>
<p>Y hacemos lo mismo con el webserver2</p>
<p><img alt="imagen 23" src="assets/images/23.png" /></p>
<p><img alt="imagen 24" src="assets/images/17.png" /></p>
<h2 id="cuestiones-finales">Cuestiones finales</h2>
<h3 id="cuestion-1">Cuestión 1</h3>
<p>Los siguientes métodos encontrados son los más comunes que he visto:</p>
<ul>
<li>
<p>Round Robin: Asigna solicitudes secuencialmente entre los servidores.</p>
</li>
<li>
<p>Least Connections: Envía la solicitud al servidor con menos conexiones activas.</p>
</li>
<li>
<p>IP Hash: Utiliza la IP del cliente para definir siempre el mismo servidor en función de su dirección</p>
</li>
</ul>
<h3 id="cuestion-2">Cuestión 2</h3>
<p>El bloque de server se encarga de redirigir el tráfico a los backend_hosts. Estos son el grupo de servidores definidos arriba en el bloque de upstream. Este bloque se encarga de la redirección y de que patrón seguir. Ahí añadiremos los servidores, donde la primera raya es donde tiene que estar la ip del servidor y en la siguiente raya después de los dos puntos el puerto que escucha el servidor. </p>
<h3 id="cuestion-3">Cuestión 3</h3>
<p>Deberíamos seguir dos pasos:</p>
<ul>
<li>
<p>Definir el bloque upstream  para añadir la ip y los puertos de las peticiones, así añadiendo la función de balanceador.</p>
</li>
<li>
<p>Definir en el bloque location el proxy_pass que redirija las peticiones a los servidores definidos en el upstream.</p>
</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": ".", "features": [], "search": "assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.83f73b43.min.js"></script>
      
    
  </body>
</html>